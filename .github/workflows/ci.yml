name: ðŸ§ª CI/CD Pipeline - Ask Me Copilot Extension

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION_MATRIX: '["18.x", "20.x", "22.x"]'
  VSCODE_VERSION_MATRIX: '["stable", "insiders"]'

jobs:
  # =====================================================
  # ðŸ” Code Quality & Linting
  # =====================================================
  lint:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run ESLint
        run: npm run lint

      - name: ðŸ“Š Check TypeScript compilation
        run: npm run compile

      - name: ðŸ“‹ Validate package.json
        run: |
          node -e "
            const pkg = require('./package.json');
            console.log('âœ… Package validation:');
            console.log(\`   Name: \${pkg.name}\`);
            console.log(\`   Version: \${pkg.version}\`);
            console.log(\`   VS Code Engine: \${pkg.engines.vscode}\`);
            console.log(\`   Language Model Tools: \${pkg.contributes.languageModelTools.length}\`);
            
            // Validate required fields
            if (!pkg.name || !pkg.version || !pkg.main) {
              throw new Error('Missing required package.json fields');
            }
            
            // Validate MCP tools
            if (!pkg.contributes.languageModelTools || pkg.contributes.languageModelTools.length !== 5) {
              throw new Error('Expected exactly 5 language model tools');
            }
            
            console.log('âœ… Package.json validation passed');
          "

  # =====================================================
  # ðŸ§ª Unit & Integration Tests Matrix
  # =====================================================
  test:
    name: ðŸ§ª Test Suite (Node ${{ matrix.node }} | VS Code ${{ matrix.vscode }})
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: ['18.x', '20.x', '22.x']
        vscode: ['stable', 'insiders']
        exclude:
          # Reduce matrix size - skip some combinations for efficiency
          - os: macos-latest
            node: '18.x'
          - os: windows-latest
            vscode: 'insiders'

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”¨ Compile TypeScript
        run: npm run compile

      - name: ðŸ§ª Run VS Code Extension Tests
        uses: coactions/setup-xvfb@v1
        with:
          run: npm test
        env:
          VSCODE_TEST_VERSION: ${{ matrix.vscode }}

      - name: ðŸ“Š Test Results Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **OS:** ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js:** ${{ matrix.node }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VS Code:** ${{ matrix.vscode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # ðŸŽ¯ MCP Integration Tests (Special Focus)
  # =====================================================
  mcp-tests:
    name: ðŸŽ¯ MCP Integration Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”¨ Compile TypeScript
        run: npm run compile

      - name: ðŸŽ¯ Run MCP-specific tests
        uses: coactions/setup-xvfb@v1
        with:
          run: npm run test:mcp
        env:
          VSCODE_TEST_VERSION: 'stable'

      - name: ðŸ“‹ Validate MCP Tool Registration
        run: |
          echo "ðŸ” Validating MCP tool configurations..."
          node -e "
            const pkg = require('./package.json');
            const tools = pkg.contributes.languageModelTools;
            
            console.log('ðŸŽ¯ MCP Tools Validation:');
            tools.forEach((tool, index) => {
              console.log(\`\${index + 1}. \${tool.displayName}\`);
              console.log(\`   Name: \${tool.name}\`);
              console.log(\`   Schema: \${tool.inputSchema ? 'âœ…' : 'âŒ'}\`);
              console.log(\`   Required fields: \${tool.inputSchema.required?.length || 0}\`);
              console.log('');
            });
            
            // Validate tool IDs
            const expectedTools = [
              'ask-me-copilot-tool_askExpert',
              'ask-me-copilot-tool_selectFromList', 
              'ask-me-copilot-tool_reviewCode',
              'ask-me-copilot-tool_confirmAction'
            ];
            
            expectedTools.forEach(expectedId => {
              const found = tools.find(t => t.name === expectedId);
              if (!found) {
                throw new Error(\`Missing required MCP tool: \${expectedId}\`);
              }
            });
            
            console.log('âœ… All MCP tools validated successfully');
          "

  # =====================================================
  # ðŸ“¦ Extension Packaging Test
  # =====================================================
  package:
    name: ðŸ“¦ Extension Packaging
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”¨ Compile TypeScript
        run: npm run compile

      - name: ðŸ“¦ Install VSCE (VS Code Extension CLI)
        run: npm install -g @vscode/vsce

      - name: ðŸŽ Package extension
        run: vsce package --no-dependencies

      - name: ðŸ“Š Package info
        run: |
          echo "## ðŸ“¦ Extension Package Details" >> $GITHUB_STEP_SUMMARY
          ls -la *.vsix
          echo "### Package Contents:" >> $GITHUB_STEP_SUMMARY
          vsce ls >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¾ Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: ask-me-copilot-extension-${{ github.sha }}
          path: "*.vsix"
          retention-days: 30

  # =====================================================
  # ðŸ”’ Security & Dependency Check
  # =====================================================
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”’ Run security audit
        run: npm audit --audit-level=moderate

      - name: ðŸ” Check for outdated dependencies
        run: |
          echo "## ðŸ“‹ Dependency Status" >> $GITHUB_STEP_SUMMARY
          echo "### Outdated packages:" >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY || true

  # =====================================================
  # ðŸ“ˆ Performance & Size Analysis
  # =====================================================
  performance:
    name: ðŸ“ˆ Performance Analysis
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”¨ Compile TypeScript
        run: npm run compile

      - name: ðŸ“Š Analyze bundle size
        run: |
          echo "## ðŸ“ˆ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### Compiled Output:" >> $GITHUB_STEP_SUMMARY
          du -sh out/ >> $GITHUB_STEP_SUMMARY
          echo "### File breakdown:" >> $GITHUB_STEP_SUMMARY
          find out/ -name "*.js" -exec du -h {} + | sort -hr >> $GITHUB_STEP_SUMMARY

      - name: ðŸŽ¯ Extension Load Time Test
        run: |
          echo "ðŸš€ Testing extension activation performance..."
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            // Analyze extension.js size and complexity
            const extensionPath = './out/extension.js';
            if (fs.existsSync(extensionPath)) {
              const stats = fs.statSync(extensionPath);
              const content = fs.readFileSync(extensionPath, 'utf8');
              
              console.log('ðŸ“Š Extension Performance Metrics:');
              console.log(\`   File size: \${(stats.size / 1024).toFixed(2)} KB\`);
              console.log(\`   Lines of code: \${content.split('\n').length}\`);
              console.log(\`   Function count: \${(content.match(/function/g) || []).length}\`);
              console.log(\`   Class count: \${(content.match(/class /g) || []).length}\`);
              
              // Size recommendations
              if (stats.size > 100 * 1024) {
                console.log('âš ï¸  Warning: Extension size > 100KB, consider optimization');
              } else {
                console.log('âœ… Extension size is optimal');
              }
            }
          "

  # =====================================================
  # ðŸŽ‰ Success Summary
  # =====================================================
  success:
    name: ðŸŽ‰ CI/CD Success
    runs-on: ubuntu-latest
    needs: [lint, test, mcp-tests, package, security, performance]
    if: success()
    steps:
      - name: ðŸŽ‰ All checks passed
        run: |
          echo "## ðŸŽ‰ CI/CD Pipeline Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Checks:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Code quality and linting" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Cross-platform testing (3 OS Ã— 3 Node.js Ã— 2 VS Code versions)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ MCP integration tests" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Extension packaging" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security audit" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ˆ Performance analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Ready for deployment!**" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # âŒ Failure Notification
  # =====================================================
  failure:
    name: âŒ CI/CD Failure
    runs-on: ubuntu-latest
    needs: [lint, test, mcp-tests, package, security, performance]
    if: failure()
    steps:
      - name: âŒ Pipeline failed
        run: |
          echo "## âŒ CI/CD Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the failed jobs above and fix the issues." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Common issues:" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript compilation errors" >> $GITHUB_STEP_SUMMARY
          echo "- Test failures" >> $GITHUB_STEP_SUMMARY
          echo "- Linting issues" >> $GITHUB_STEP_SUMMARY
          echo "- MCP tool configuration problems" >> $GITHUB_STEP_SUMMARY
          echo "- Security vulnerabilities" >> $GITHUB_STEP_SUMMARY